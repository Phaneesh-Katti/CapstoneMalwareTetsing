Week 1 → Advanced Command and Control (C2)

1. Understand the working of a scheduler, a service, ensure that persistence of the C2 malware sample is assured.

2. Use different DLL hijacking techniques to load and persist malicious DLLs. 

3. Use images from the Internet to generate and propagate C2 commands as steg-images. Can also try using audio files like Cortana wav files. Use Stegdetect and identify how capable the tool is.

4. Employ the concept of whitelisting and blacklisting IP addresses by hosting multiple instances of an Apache Server using Virtual Hosting . 

5. Understand the basics of Powershell scripting and how Powershell can be used to turn the Windows Defender and Firewall off. 


NOTE: Please execute the file name mentioned under the "code" heading under each serial number. This is mentioned as there may be multiple files/executables in a given folder to support the neccessary functionalities. 
It may be necessary to change the Execution Policy of our Powershell to perform certain tasks. For now, we will disable/change our execution policy to Unrestricted by ourselves manually. As an attacker, one may run a Powershell command or script to do the same on the victim host. 
Open Powershell as an “Administrator” and run the following command:

'''
  Set-ExecutionPolicy -Scope CurrentUser -ExecutionPolicy Unrestricted -Force
'''

It is advised to set the execution policy back to restricted (which is the default setting) after analysing the malware behaviours

'''
  Set-ExecutionPolicy -Scope CurrentUser -ExecutionPolicy Restricted -Force
'''

You can verify the execution policy by using:

'''
  Get-ExecutionPolicy 
'''

Routing through the Week 1 Maze

1. Hello World Scehduler - 

This is the starting point of using power shell scripts for scheduling tasks

We try to write a powershell script that will add a custom executable (hello_world_scheduler.exe) as a "scheduled" task 
This executable write Hello world 10 time with an additional variable to distinguish each write evey 1 min into a file called output.txt

Code:hello_world_scheduler.exe

2. Startup addition - 

We try to write a powershell script to add any executable to the startup folder, so that it gets executed on every boot
As an attacker, one can add their malware or part of their malware to the startup folder to make it more persistent + dangerous 

In our scenario, to understadn the working, we have attempted to add command prompt to the startup folder
We can observe the .lnk file being added - basically a link file to the application 

Code: startup.ps1

3. Hello World Startup Mashup

We try to combine 1. and 2. 
We try to write a powershell script that adds cmd to starup which executes a code similar to hello world scehduler to write hello world into a file 

Code: hello-world_startup.ps1

4. Custom startup Mashup 

Instead of using a normal application/executable like cmd, we do the same as 3. but add a custom executable (myC.exe) to the startup folder

Code: myC-startup.ps1

5. Additional - Port Scheduler (NOTE - ADDITIONAL WORK!!!)

Here we try to write a powershell script which opens a connection on a port and then closes it
We attempt to simulate the way attackers might try to keep in touch with target host periodically 
We run the powershell script that runs the executable which handles the connection opening and closing

Code: port_scheduler.ps1

6. Powershell execution Policy

Rather than using powershell script to run commands present in an executable, we try to run a command directly using powershell commands itself
Sometimes, this requires changing the Execution policy in our powershell which is "Restricted" by default
we can try the "Bypass" or the "Unrestricted" option 

Code: power.exe

7. Advanced C2

The server (attacker) connects with the victim client. Due to a scheduler injected into the victim, the victim keeps executing the command sent by attacker
In our scenario, attacker commands the victim to send the contents of a file to the attacker server, any changes are also reflected because of the scehduler that keeps periodically sending the file's contents to the attackers. This can be useful for exfiltrating the contents of like a password file. In our case the file data being exfiltrated is example.txt

Code: server.exe on attacer host and client_scheduler.ps1 on victim host (Make sure to update the IP addresses in the client code to the attackers IP and ideally for our code snippet, both the client and server should be on the same network to make it easier 
